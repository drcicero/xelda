local objs = require "objs"
local cron = require "effects.cron"
local audio = require "effects.audio"
local scripting = require "scripting"

local dialog = scripting.dialog
local wander_by = scripting.wander_by

return {
  load = function ()
    for i,o in pairs(scripting.byClass("carpet")) do
      o.gravity = 0
      o.vy = 0
    end

    scripting.byId("goleft").properties.onfirsttouch = "$scene"
  end,

  funcs = {
    scene = function ()
    cutscene("hello", function ()
      fairy = objs.spawn("FAIRY", 18.5*20, 10*20)
      fairy.properties.image = "Watson"
      fairy.gravity = 0

      wander_by(fairy, -5*20, -10)

      avatar.facing = avatar.x > fairy.x and -1 or 1
      dialog(fairy, "Where is the king?")
      wander_by(fairy, -5*20, -10)

      dialog(" Well thats strange... But then again, there is no time.")
      wander_by(fairy, 1*20, -10)

      dialog(fairy, " Maybe he is already in the secret chamber of THE GREEN ONE.")
      function nth_call(times, func)
        return function(...)
          times = times - 1
          if times == 0 then func(...) end
        end
      end

      audio.play "tadadi"
      local continue = nth_call(4, resume)
      for i,o in pairs(scripting.byClass("carpet")) do
        sceneclock.add {dur=4, f=cron.by(o, "y", -50), ended=continue}
      end

      dialog(fairy, "Has anyone ever told you the saga of our land?")
      wander_by(fairy, -2*20, -20)
      wander_by(fairy, -3*20, 40)

--      dialog(" Follow me.")
--          wander_by(fairy, -3*20, 40)

      objs.del(fairy)

    end) end,
  },
}

